<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - AISERS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="Photos/PHILSCA-LOGO-WINGS.png" alt="Aisers Logo" style="height:48px;width:auto;margin-right:12px;">
                <span class="fw-bold" style="letter-spacing:2px;font-size:1.5rem;">Alliance Web</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link">Home</a>
                    </li>
                    <li class="nav-item" id="logoutBtnContainer" style="display: none;">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login Form -->
    <div class="container mt-5 pt-5" id="loginSection">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <h2 class="text-center mb-4">Admin Login</h2>
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Login</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="container mt-5 pt-5" id="dashboardSection" style="display: none;">
        <h2 class="mb-4">Admin Dashboard</h2>
        
        <!-- Announcements Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title mb-0">Manage Announcements</h3>
            </div>
            <div class="card-body">
                <!-- Add New Announcement Form -->
                <form id="announcementForm" class="mb-4">
                    <div class="mb-3">
                        <label for="announcementTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="announcementTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="announcementContent" class="form-label">Content</label>
                        <textarea class="form-control" id="announcementContent" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="announcementImage" class="form-label">Image (Optional)</label>
                        <input type="file" class="form-control" id="announcementImage" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Post Announcement</button>
                </form>

                <!-- Existing Announcements List -->
                <h4>Existing Announcements</h4>
                <div id="announcementsList" class="list-group">
                    <!-- Announcements will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check login status and show appropriate section
        function checkLoginStatus() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            document.getElementById('loginSection').style.display = isLoggedIn ? 'none' : 'block';
            document.getElementById('dashboardSection').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('logoutBtnContainer').style.display = isLoggedIn ? 'block' : 'none';
        }

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Simple authentication (replace with your actual authentication logic)
            if (username === 'AISERS' && password === 'AISERS2526') {
                sessionStorage.setItem('adminLoggedIn', 'true');
                checkLoginStatus();
                loadAnnouncements();
            } else {
                alert('Invalid credentials. Please try again.');
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            sessionStorage.removeItem('adminLoggedIn');
            window.location.href = 'index.html';
        });

        // API base path (used only for local/dev server)
        const API_BASE = '/api/announcements';
        const IS_GITHUB_PAGES = /\.github\.io$/.test(location.hostname);

        function detectGithubRepo() {
            if (window.GITHUB_OWNER && window.GITHUB_REPO) {
                return { owner: window.GITHUB_OWNER, repo: window.GITHUB_REPO };
            }
            if (!IS_GITHUB_PAGES) return null;
            const owner = location.hostname.split('.')[0];
            const repo = location.pathname.replace(/^\/+/, '').split('/')[0] || 'AllianceWeb';
            return { owner, repo };
        }

        async function fetchAnnouncementsFromGithubIssues() {
            const repoInfo = detectGithubRepo();
            if (!repoInfo) return null;
            const { owner, repo } = repoInfo;
            const labelQuery = 'announcement,announcements,Announcement,Announcements';
            const urls = [
                `https://api.github.com/repos/${owner}/${repo}/issues?labels=${encodeURIComponent(labelQuery)}&state=open&per_page=100`,
                `https://api.github.com/repos/${owner}/${repo}/issues?state=open&per_page=50`
            ];
            for (const url of urls) {
                try {
                    const resp = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' }, cache: 'no-store' });
                    if (!resp.ok) continue;
                    const issues = (await resp.json()).filter(i => !i.pull_request);
                    if (!issues || issues.length === 0) continue;
                    const markdownImgRegex = /!\[[^\]]*\]\(([^)]+)\)/i;
                    const htmlImgRegex = /<img[^>]*src=["']([^"']+)["'][^>]*>/i;
                    const urlImgRegex = /\bhttps?:\/\/[^\s)]+\.(?:png|jpe?g|gif|webp|svg)\b/i;
                    return issues.map(i => {
                        const body = i.body || '';
                        let image = null;
                        const md = markdownImgRegex.exec(body);
                        const html = htmlImgRegex.exec(body);
                        const urlOnly = urlImgRegex.exec(body);
                        if (md) image = md[1];
                        else if (html) image = html[1];
                        else if (urlOnly) image = urlOnly[0];
                        const cleaned = body
                          .replace(/!\[[^\]]*\]\(([^)]+)\)/g, '')
                          .replace(/<img[^>]*>/gi, '')
                          .trim();
                        return {
                            id: String(i.number),
                            title: i.title,
                            content: cleaned,
                            date: new Date(i.created_at).getTime(),
                            image
                        };
                    });
                } catch (_) {}
            }
            return null;
        }

        // Handle announcement form submission
        document.getElementById('announcementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            const imageFile = document.getElementById('announcementImage').files[0];
            
            try {
                // On GitHub Pages, redirect to a prefilled GitHub Issue instead of calling the API
                if (IS_GITHUB_PAGES) {
                    const repoInfo = detectGithubRepo();
                    if (!repoInfo) throw new Error('Repo not detected');
                    const { owner, repo } = repoInfo;
                    const issueUrl = `https://github.com/${owner}/${repo}/issues/new?labels=announcement&title=${encodeURIComponent(title)}&body=${encodeURIComponent(content + (imageFile ? '\n\n[Attach image after opening the issue]' : ''))}`;
                    window.open(issueUrl, '_blank');
                    alert('Opening GitHub Issue to post the announcement. After creating it, refresh this page.');
                    return;
                }

                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                const resp = await fetch(API_BASE, {
                    method: 'POST',
                    body: formData
                });

                if (!resp.ok) {
                    throw new Error('Failed to post announcement');
                }

                alert('Announcement posted successfully!');
                this.reset();
                loadAnnouncements();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to post announcement. Please try again.');
            }
        });

        // Function to load existing announcements
        async function loadAnnouncements() {
            const announcementsList = document.getElementById('announcementsList');
            announcementsList.innerHTML = '';

            try {
                let announcements = null;
                if (IS_GITHUB_PAGES) {
                    announcements = await fetchAnnouncementsFromGithubIssues();
                } else {
                    const resp = await fetch(API_BASE);
                    if (!resp.ok) throw new Error('Failed to load announcements');
                    announcements = await resp.json();
                }

                if (!announcements || announcements.length === 0) {
                    announcementsList.innerHTML = '<div class="text-center">No announcements yet.</div>';
                    return;
                }

                announcements.forEach(announcement => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-1">${announcement.title}</h5>
                            <button class="btn btn-danger btn-sm" onclick="deleteAnnouncement('${announcement.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="mb-1">${announcement.content}</p>
                        ${announcement.image ? `<img src="${announcement.image}" class="img-thumbnail mt-2" style="max-width: 200px;">` : ''}
                        <small class="text-muted">Posted on: ${new Date(announcement.date).toLocaleDateString()}</small>
                    `;
                    announcementsList.appendChild(item);
                });
            } catch (error) {
                console.error('Error:', error);
                announcementsList.innerHTML = '<div class="text-center text-danger">Failed to load announcements.</div>';
            }
        }

        // Function to delete an announcement
        async function deleteAnnouncement(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;
            try {
                const resp = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                if (!resp.ok && resp.status !== 204) throw new Error('Failed to delete');
                loadAnnouncements();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to delete announcement. Please try again.');
            }
        }

        // Check login status when page loads
        checkLoginStatus();
        // Load announcements if logged in
        if (sessionStorage.getItem('adminLoggedIn')) {
            loadAnnouncements();
        }
    </script>
</body>
</html> 